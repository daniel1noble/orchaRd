---
title: "leave_one_out() and orchard_leave1out() with phylogenetic matrix"
author: "fd"
date: "2025-03-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE, warning=FALSE}
library(metafor)
library(devtools)
library(rotl)
library(ape)
load_all() # Load dev package
```

# Example with subset from Pottier data

Use only a subset to avoid long runtimes in leave-one-out

```{r}
data("pottier")
pottier_subset <- pottier[1:20, ]
```

Get the phylo tree using `rotl`

```{r, warning=FALSE, results='hide'}
unique_names <- unique(pottier_subset$search_string)
taxa <- tnrs_match_names(unique_names)

tree <- tol_induced_subtree(taxa$ott_id)
tree$tip.label <- strip_ott_ids(tree$tip.label)
```


```{r, warning=FALSE}
plot(tree)
```


```{r}
tree <- ape::compute.brlen(tree)
phylo_matrix <- ape::vcv(tree, corr = TRUE)

phylo_matrix
```

```{r}
# Simplified model just for the example
res <- rma.mv(yi = dARR,
              V = Var_dARR,
              test = "t",
              random = list(~1 | species_ID,
                            ~1 | phylogeny),
              R = list(phylogeny = phylo_matrix),
              data = pottier_subset)
res
```
```{r}
loo_test <- leave_one_out(res,
                          group = "phylogeny",
                          phylo_args = list(tree = tree, species_colname = "phylogeny"))

loo_test
```

```{r}
orchard_leave1out(leave1out = loo_test,
                  xlab = "dARR",
                  ylab = "Species left out",
                  trunk.size = 1.2,
                  branch.size = 1.5,
                  alpha = 0.2,
                  legend.pos = "top.out")
```

### Just for testing: remove Danio_rerio by hand

```{r}
subset2 <- subset(pottier_subset, phylogeny != "Danio_rerio")
```

The function `.prune_tree()` is a simplified version of Dan's code. It is used internally

```{r}
kept_spp <- unique(subset2$phylogeny)
tree2 <- .prune_tree(tree, kept_spp)
plot(tree2)
```


```{r}
tree2 <- ape::compute.brlen(tree2)
phylo_matrix2 <- ape::vcv(tree2, corr = TRUE)
phylo_matrix2
```

```{r}
res2 <- rma.mv(yi = dARR,
               V = Var_dARR,
               test = "t",
               random = list(~1 | species_ID,
                             ~1 | phylogeny),
               R = list(phylogeny = phylo_matrix2),
               data = subset2)
```

By-hand result:

```{r}
mod_results(res2, group = "phylogeny")
```

`leave-one-out` result:

```{r}
subset(loo_test$mod_table, name == "Danio_rerio")
```

## Notes:

- To-do: Write good documentation and examples

- To-do: Add error messages for models that use phylogeny but don't pass phylo_args (same for vcalc and robust)

- It doesn't work with moderators. For example, I got an error if I use the model from the vignette. Don't know if it is worth the effort to make this work.
