---
title: "Leave-one-out test"
author: "fd"
date: "2025-02-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(metafor)
library(devtools)
load_all() # Load dev package
```

### Example with Eklof data

```{r}
data(eklof)

# Calculate the effect size
eklof <- escalc(measure = "ROM",
                n1i = N_control,
                sd1i = SD_control,
                m1i = mean_control, 
                n2i = N_treatment,
                sd2i = SD_treatment,
                m2i = mean_treatment,
                var.names = c("lnRR", "vlnRR"),
                data = eklof)

# Add the observation level factor
eklof$Datapoint <- as.factor(seq(1, dim(eklof)[1], 1))

# Also, we can get the sample size, which we can use for weighting if we would like
eklof$N <- rowSums(eklof[, c("N_control", "N_treatment")])
```

Create **Authors** column with first author and year, to make it pretty

```{r}
eklof <- eklof %>% 
  mutate(Author = paste(First.author, Publication.year, sep = ", "))
```


```{r}
# fit a meta-regression with the intercept (contrast)
eklof_MR0 <- rma.mv(yi = lnRR,
                    V = vlnRR,
                    mods = ~Grazer.type,
                    random = list(~1 | ExptID,
                                  ~1 | Datapoint),
                    data = eklof)

results <- mod_results(eklof_MR0, group = "Author")
results
```

## leave-one-out plot

Accepts all the arguments from orchard_plot()

```{r}
orchard_leave1out(eklof_MR0,
                  group = "Author",
                  xlab = "lnRR",
                  ylab = "Study left out",
                  trunk.size = 1.2,
                  branch.size = 1.5,
                  legend.pos = "top.out") 

```


## Example with BCG vaccine data from metafor

```{r}
dat <- metafor::escalc(measure = "RR", ai = tpos, bi = tneg, ci = cpos, di = cneg, data = dat.bcg)

dat <- dat %>% 
  mutate(reference = paste(author, year, sep = ", ")) 
  
res <- metafor::rma(yi, vi, data = dat)
```

Add a lot of arguments just to see if they work

```{r}
orchard_leave1out(res,
                  group = "reference",
                  xlab = "lnRR",
                  ylab = "Study left out",
                  legend.pos = "bottom.out", 
                  trunk.size = 1.2,
                  branch.size = 1.3,
                  twig.size = 0,
                  k.pos = "none",
                  alpha = 0.2,
                  cb = FALSE) +
  scale_fill_viridis_d()
```



## Function leave_one_out()

The function leave_one_out() returns the results, imitating the output from mod_results(). It could be useful if someone wants to use the results for something else.

```{r}
res_loo <- leave_one_out(res, group = "reference")
res_loo
```

For comparison, this is the output from metafor's leave1out:

```{r}
metafor::leave1out(res)
```

The results from leave_one_out() can be used for custom ggplot2 plots, for example:

```{r}
res_loo$mod_table %>% 
  ggplot(aes(x = reorder(name, -estimate),
             y = estimate,
             ymin = lowerCL,
             ymax = upperCL)) +
  geom_pointrange() +
  coord_flip() +
  geom_hline(yintercept = res$beta, linetype = 2, color = "blue") +
  geom_hline(yintercept = 0, linetype = 2, color = "black") +
  xlab("Study left out") +
  ylab("lnRR") +
  ylim(-1.5, 0.5) +
  theme_minimal()
```



## To-do

- **orchard_plot()**: There are only 20 colors, but they are not recycled. This is a problem when there are more than 20 studies (or whatever group is used)
- Transformation is not working yet. This is because the transformation is handled inside orchard_plot() and the lines for 95% CI are added on top of the orchard plot. Maybe move the transformation out of orchard_plot() to a separate function?
- Only works for intercepts, No mod, no 'by' argument. Fix this
- Make inner lines optional
- Add some arguments to modify the 95% confidence lines and also add the overall estimate
