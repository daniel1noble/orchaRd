---
title: "Leave-one-out test"
author: "fd"
date: "2025-03-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(metafor)
library(devtools)
load_all() # Load dev package
```

## orchard_leave1out()

orchard_leave1out() is a function that creates an orchard plot with the results from a leave-one-out analysis. It is useful to see how the overall estimate changes when each study is left out.

For each left-out study, the plot shows the effect sizes, the model estimate, along with c
confidence and prediction intervals. Also, it show the points left out in that analysis as 'ghost points'.


### Example 1: Eklof data

```{r}
data(eklof)

# Calculate the effect size
eklof <- escalc(measure = "ROM",
                n1i = N_control,
                sd1i = SD_control,
                m1i = mean_control, 
                n2i = N_treatment,
                sd2i = SD_treatment,
                m2i = mean_treatment,
                var.names = c("lnRR", "vlnRR"),
                data = eklof)

# Add the observation level factor
eklof$Datapoint <- as.factor(seq(1, dim(eklof)[1], 1))

# Also, we can get the sample size, which we can use for weighting if we would like
eklof$N <- rowSums(eklof[, c("N_control", "N_treatment")])
```

Create **Authors** column with first author and year, to make it pretty

```{r}
eklof <- eklof %>% 
  mutate(Author = paste(First.author, Publication.year, sep = ", "))
```


```{r}
# fit a meta-regression with the intercept (contrast)
eklof_MR0 <- rma.mv(yi = lnRR,
                    V = vlnRR,
                    mods = ~Grazer.type,
                    random = list(~1 | ExptID,
                                  ~1 | Datapoint),
                    data = eklof)

results <- mod_results(eklof_MR0, group = "Author")
results
```

You can create the default leave-one-out plot like this:

```{r}
orchard_leave1out(model = eklof_MR0,
                  group = "Author",
                  xlab  = "lnRR")
```

But you may want to make changes to the plot. Most of the changes can be done using the arguments from orchard_plot():

```{r}
orchard_leave1out(eklof_MR0,
                  group = "Author",
                  xlab = "lnRR",
                  trunk.size = 1.2,
                  branch.size = 1.5,
                  alpha = 0.1,
                  legend.pos = "top.out")
```

And there are also a few arguments that are specific to 'orchard_leave1out()':

- ylab: String. with the label for the y-axis. 

- ci_lines: Logical. If TRUE, the 95% CI lines are added to the plot. Default is TRUE.

- ci_lines_color: String. Color for the 95% CI lines. Default is "black".

- ghost_points: Logical. If TRUE, the points for the studies left out are added to the plot. Default is TRUE.

```{r}
orchard_leave1out(eklof_MR0,
                  group = "Author",
                  xlab = "lnRR",
                  trunk.size = 1.2,
                  branch.size = 1.5,
                  alpha = 0.1,
                  legend.pos = "top.out",
                  ylab = "Study left out",
                  ci_lines_color = "darkorchid")
```

You can also remove 'ghost_points'. 
They help to see the points that are left out, but they can be removed:


```{r}
orchard_leave1out(eklof_MR0,
                  group = "Author",
                  xlab = "lnRR",
                  trunk.size = 1.2,
                  branch.size = 1.5,
                  alpha = 0.1,
                  legend.pos = "top.out",
                  ylab = "Study left out",
                  ci_lines_color = "darkorchid",
                  ghost_points = FALSE)
```




## Example with BCG vaccine data from metafor

```{r}
dat <- metafor::escalc(measure = "RR", ai = tpos, bi = tneg, ci = cpos, di = cneg, data = dat.bcg)

dat <- dat %>% 
  mutate(reference = paste(author, year, sep = ", ")) 
  
res <- metafor::rma(yi, vi, data = dat)
```

Add a lot of arguments just to see if they work

```{r}
orchard_leave1out(res,
                  group = "reference",
                  xlab = "lnRR",
                  ylab = "Study left out",
                  legend.pos = "bottom.out", 
                  trunk.size = 1.2,
                  branch.size = 1.3,
                  twig.size = 0,
                  k.pos = "none",
                  alpha = 0.2) 
```

Sometimes the first plot is not good enough, so you have to make some changes.

orchard_leave1out() can be slow because it runs all the meta-analytic models needed for the leave-one-out.
For those cases, it is possible to run leave_one_out(),
save the result and use it for orchard_leave1out(), so you don't have to refit 
a lot of models each time you want to make a tweak in the plot.

Note that orchard_leave1out() still needs the 'model' and 'group' arguments to get the overall estimate and 95% CI
and to know how to group the effect sizes.

The output from leave_one_out() is passed as 'loo_output':

```{r}
res_loo <- leave_one_out(res, group = "reference")
```


```{r}
orchard_leave1out(model = res,
                  loo_output = res_loo,
                  group = "reference",
                  xlab = "lnRR",
                  ylab = "Study left out",
                  trunk.size = 1.2,
                  branch.size = 1.5,
                  alpha = 0.1,
                  legend.pos = "top.out",
                  k.pos = "none")
```

## leave_one_out()

The function leave_one_out() returns the results, imitating the output from mod_results(). It could be useful if someone wants to use the results for something else.

```{r}
res_loo <- leave_one_out(res, group = "reference")
res_loo
```

For comparison, this is the output from metafor's leave1out:

```{r}
metafor::leave1out(res)
```

The results from leave_one_out() can be used for custom ggplot2 plots, for example:

```{r}
res_loo$mod_table %>% 
  ggplot(aes(x = reorder(name, -estimate),
             y = estimate,
             ymin = lowerCL,
             ymax = upperCL)) +
  geom_pointrange() +
  coord_flip() +
  geom_hline(yintercept = res$beta, linetype = 2, color = "blue") +
  geom_hline(yintercept = 0, linetype = 2, color = "black") +
  xlab("Study left out") +
  ylab("lnRR") +
  ylim(-1.5, 0.5) +
  theme_minimal()
```



## Notes and to-do

- **orchard_plot()**: There are only 20 colors, but they are not recycled. This is a problem when there are more than 20 studies (or whatever group is used)
- Transformation is not working yet. This is because the transformation is handled inside orchard_plot() and the lines for 95% CI are added on top of the orchard plot. Maybe move the transformation out of orchard_plot() to a separate function?
- Only works for intercepts, No mod, no 'by' argument. Fix this
- Maybe there should be separate argument for `group` called `leave_out_goup` or something like that. For example, if a user want to leave out one species at a time and still plot the results using group by paper. 
- Add some arguments to modify the 95% confidence lines and also add the overall estimate
